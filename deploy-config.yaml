# deploy-config.yaml â€”â€” æ”¯æŒ SSH ç›´è¿ & Agent åå‘ä»£ç†åŒæ¨¡å¼
version: "1.0"

app:
  name: "api-gateway"
  repo: "git.example.com/prod/api-gateway"
  branches: ["main", "release/*"]

# âœ… ç»Ÿä¸€ target æè¿°ï¼šæ— è®ºç”¨ SSH è¿˜æ˜¯ Agentï¼Œéƒ½å« "target"
targets:
  - name: "edge-prod-01" # é€»è¾‘åç§°ï¼ˆç”¨äºæ—¥å¿—ã€å‘Šè­¦ï¼‰
    mode: "agent" # â† å…³é”®ï¼šå¯é€‰ "ssh" | "agent"

    # ğŸ”¹ å½“ mode == "ssh" æ—¶ï¼Œä½¿ç”¨ä»¥ä¸‹å­—æ®µï¼ˆåŸæ ·ï¼‰
    # host: "192.168.10.5"
    # port: 22
    # user: "deploy"
    # identity_file: "/etc/secrets/id_rsa"

    # ğŸ”¹ å½“ mode == "agent" æ—¶ï¼Œä½¿ç”¨ä»¥ä¸‹å­—æ®µï¼ˆæ–°ï¼‰
    agent:
      name: "xxxä¸»æœºå" # ä¸»æœºå
      token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." # JWT æˆ–é™æ€ Tokenï¼ˆå»ºè®® Vault æ³¨å…¥ï¼‰
      # æˆ–ç”¨ short-lived tokenï¼štoken_env: "DEPLOY_AGENT_TOKEN"ï¼ˆä» env è¯»å–ï¼‰

    # ğŸŒ å…¬å…±é…ç½®ï¼ˆSSH å’Œ Agent å‡é€‚ç”¨ï¼‰
    docker:
      image_template: "{{ registry }}/{{ app.name }}:{{ tag }}"
      container_name: "api-gateway-prod"
      restart_policy: "always"
      ports:
        - "8000:8000"
      env:
        - "ENV=production"
      volumes:
        - "/data/api-gateway:/app/data"
      health_check:
        url: "http://localhost:8000/health"
        timeout: "10s"

# ğŸ›¡ï¸ ç­–ç•¥ï¼ˆä¸å˜ï¼‰
policy:
  require_image_digest: true
  max_concurrent_deployments: 1
