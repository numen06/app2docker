<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jar2Docker - 一键构建 & 推送 Docker 镜像</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { padding-top: 2rem; background: #f8f9fa; }
        .card { box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); margin-bottom: 2rem; }
        .log-container {
            background: #2d2d2d; color: #f8f9fa; font-family: 'Courier New', monospace;
            height: 400px; overflow-y: auto; padding: 1rem; border-radius: 0.5rem;
            white-space: pre-wrap; word-wrap: break-word;
        }
        .log-container .error { color: #ff6b6b; font-weight: bold; }
        .log-container .success { color: #51cf66; font-weight: bold; }
        .template-preview {
            background: #f1f3f5; padding: 1rem; border-radius: 0.5rem;
            font-family: 'Courier New', monospace; font-size: 0.9em;
            max-height: 200px; overflow-y: auto;
        }
        .btn-build { position: relative; }
        .spinner { display: none; margin-left: 0.5rem; }
        #imagename, #tag { font-family: 'Courier New', monospace; }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <h1><i class="fas fa-box-open text-primary"></i> Jar2Docker</h1>
            <p class="lead text-muted">上传 JAR 文件，一键构建并推送 Docker 镜像</p>
        </div>

        <!-- 配置卡片 -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-cog"></i> Docker 配置</h5>
            </div>
            <div class="card-body">
                <form id="configForm" accept-charset="UTF-8">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Registry 地址</label>
                            <input type="text" name="registry" class="form-control" placeholder="docker.io">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">镜像前缀（可选）</label>
                            <input type="text" name="registry_prefix" class="form-control" placeholder="your-namespace">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">暴露端口</label>
                            <input type="number" name="expose_port" class="form-control" value="8080">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="form-check">
                                <input type="checkbox" name="default_push" class="form-check-input" id="defaultPush">
                                <label class="form-check-label" for="defaultPush">默认推送镜像</label>
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-outline-primary w-100">
                                <i class="fas fa-save"></i> 保存配置
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 上传构建卡片 -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-cloud-upload-alt"></i> 上传 JAR 并构建</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data" accept-charset="UTF-8">
                    <div class="mb-3">
                        <label class="form-label">选择 JAR 文件 <span class="text-danger">*</span></label>
                        <input type="file" name="jar_file" class="form-control" accept=".jar" required>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">使用模板</label>
                            <select name="template" class="form-select">
                            </select>
                            <div class="form-text">选择预设 Dockerfile 模板</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">或上传自定义 Dockerfile</label>
                            <input type="file" name="custom_dockerfile" class="form-control" accept=".dockerfile,.txt">
                        </div>
                    </div>

                    <div class="template-preview mb-3 d-none">
                        <label class="form-label">模板预览</label>
                        <div class="template-content"></div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">镜像名称</label>
                            <input type="text" name="imagename" id="imagename" class="form-control" placeholder="myapp/demo" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">标签</label>
                            <input type="text" name="tag" id="tag" class="form-control" value="latest">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <div class="form-check">
                                <input type="checkbox" name="push" class="form-check-input" id="pushImage">
                                <label class="form-check-label" for="pushImage">构建后推送</label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg btn-build w-100">
                        <i class="fas fa-hammer"></i> 开始构建
                        <span class="spinner-border spinner-border-sm spinner ms-2" role="status"></span>
                    </button>
                </form>
            </div>
        </div>

        <!-- 构建日志卡片 -->
        <div class="card">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-terminal"></i> 构建日志</h5>
                <button class="btn btn-sm btn-outline-light" id="clearLog"><i class="fas fa-trash"></i></button>
            </div>
            <div class="card-body p-0">
                <div class="log-container" id="buildLog"></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(function() {
            const $log = $('#buildLog');
            const $form = $('#uploadForm');
            const $configForm = $('#configForm');
            const $templateSelect = $('select[name="template"]');
            const $templatePreview = $('.template-preview');
            const $templateContent = $('.template-content');
            const $spinner = $('.spinner');
            const $pushImage = $('#pushImage');
            const $defaultPush = $('#defaultPush');

            // 加载配置
            function loadConfig() {
                $.getJSON('/get-config')
                    .done(data => {
                        const docker = data.docker || {};
                        $('input[name="registry"]').val(docker.registry || 'docker.io');
                        $('input[name="registry_prefix"]').val(docker.registry_prefix || '');
                        $('input[name="expose_port"]').val(docker.expose_port || 8080);
                        $defaultPush.prop('checked', !!docker.default_push);
                        $pushImage.prop('checked', !!docker.default_push);
                    })
                    .fail(err => {
                        appendLog('❌ 加载配置失败，请检查服务是否正常', 'error');
                    });
            }

            // 加载模板列表
            function loadTemplates() {
                $.getJSON('/list-templates')
                    .done(data => {
                        (data.templates || []).forEach(t => {
                            $templateSelect.append(`<option value="${t}">${t}</option>`);
                        });
                    })
                    .fail(() => {
                        appendLog('⚠️ 加载模板列表失败', 'error');
                    });
            }

            // 预览模板
            $templateSelect.on('change', function() {
                const template = $(this).val();
                if (!template) {
                    $templatePreview.addClass('d-none');
                    return;
                }
                $.post('/suggest-image-name', new FormData($form[0]), null, false)
                    .done(() => {}) // trick: 触发文件上传以获取文件名
                    .always(() => {
                        $.get(`/templates/${template}.Dockerfile`)
                            .done(content => {
                                $templateContent.text(content);
                                $templatePreview.removeClass('d-none');
                            })
                            .fail(() => {
                                $templateContent.text('❌ 无法加载模板内容');
                                $templatePreview.removeClass('d-none');
                            });
                    });
            });

            // 文件选择后建议镜像名
            $('input[name="jar_file"]').on('change', function() {
                if (!this.files.length) return;
                const formData = new FormData();
                formData.append('jar_file', this.files[0]);

                $.ajax({
                    url: '/suggest-image-name',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(res) {
                        if (res.suggested_imagename) {
                            $('input[name="imagename"]').val(res.suggested_imagename);
                        }
                    },
                    error: function() {
                        appendLog('⚠️ 自动生成镜像名失败', 'error');
                    }
                });
            });

            // 保存配置
            $configForm.on('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                $.ajax({
                    url: '/save-config',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(res) {
                        if (res.message) {
                            appendLog(`✅ ${res.message}`, 'success');
                            $pushImage.prop('checked', res.docker_config?.default_push || false);
                        }
                    },
                    error: function(xhr) {
                        try {
                            const res = JSON.parse(xhr.responseText);
                            appendLog(`❌ ${res.error}`, 'error');
                        } catch {
                            appendLog('❌ 保存配置失败', 'error');
                        }
                    }
                });
            });


            // 构建处理
            $form.on('submit', function(e) {
                e.preventDefault();

                $log.empty();
                $spinner.show();
                $('button[type="submit"]').prop('disabled', true);

                const formData = new FormData(this);


                $.ajax({
                    url: '/upload',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(res) {
                        appendLog(res.message);
                        // 循环调用日志
                        pollLogs(res.build_id)
                    },
                    complete: function() {
                        $spinner.hide();
                        $('button[type="submit"]').prop('disabled', false);
                        $log.scrollTop($log[0].scrollHeight);
                    },
                    error: function(xhr) {
                        $spinner.hide();
                        $('button[type="submit"]').prop('disabled', false);
                        try {
                            const res = JSON.parse(xhr.responseText);
                            appendLog(`❌ ${res.error}`, 'error');
                        } catch {
                            appendLog('❌ 上传或构建失败', 'error');
                        }
                    }
                });
            });

            async function pollLogs(buildId) {
                const logArea = document.getElementById('log');
                let lastLength = 0;

                while (true) {
                    try {
                        const res = await fetch(`/get-logs?build_id=${encodeURIComponent(buildId)}`);
                        if (!res.ok) break;
                        const logs = await res.text();
                        if (logs.length > lastLength) {
                              appendLog(logs);
                              lastLength = logs.length;
                        }

                        // 检查构建是否结束（可选：通过额外接口判断状态）
                        await new Promise(resolve => setTimeout(resolve, 500)); // 500ms 轮询
                    } catch (e) {
                        console.error("日志轮询失败:", e);
                        break;
                    }
                }
            }



            // 清空日志
            $('#clearLog').on('click', function() {
                $log.empty();
            });

            // 日志追加工具函数
            function appendLog(text, type = '') {
                const $line = $('<div>').text(text);
                if (type) $line.addClass(type);
                if (text.includes('❌')) $line.addClass('error');
                if (text.includes('✅')) $line.addClass('success');
                $log.append($line);
                $log.scrollTop($log[0].scrollHeight);
            }

            // 初始化
            loadConfig();
            loadTemplates();
        });
    </script>
</body>
</html>