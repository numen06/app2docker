<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jar2Docker - 一键构建 & 推送 Docker 镜像</title>
    <link href="static/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="static/fontawesome/all.min.css">
    <link rel="stylesheet" href="static/codemirror/css/codemirror.min.css">
    <link rel="stylesheet" href="static/codemirror/css/monokai.min.css">
    <style>
        body { padding-top: 2rem; background: #f8f9fa; }
        .card { box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); margin-bottom: 2rem; }
        .log-container {
            background: #2d2d2d; color: #f8f9fa; font-family: 'Courier New', monospace;
            height: 400px; overflow-y: auto; padding: 1rem; border-radius: 0.5rem;
            white-space: pre-wrap; word-wrap: break-word;
        }
        .log-container .error { color: #ff6b6b; font-weight: bold; }
        .log-container .success { color: #51cf66; font-weight: bold; }
        .template-preview {
            background: #f1f3f5; padding: 1rem; border-radius: 0.5rem;
            font-family: 'Courier New', monospace; font-size: 0.9em;
            max-height: 200px; overflow-y: auto;
        }
        .btn-build { position: relative; }
        .spinner { display: none; margin-left: 0.5rem; }
        #imagename, #tag { font-family: 'Courier New', monospace; }
        .CodeMirror {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            height: 320px;
            font-size: 14px;
        }
        .CodeMirror-scroll {
            max-height: 320px;
            overflow-y: auto !important;
        }
        .CodeMirror-focused {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <h1><i class="fas fa-box-open text-primary"></i> Jar2Docker</h1>
            <p class="lead text-muted">上传 JAR 文件，一键构建并推送 Docker 镜像</p>
        </div>

        <!-- 上传构建卡片 -->
        <div class="card">
            <div class="card-header bg-success text-white d-flex flex-wrap gap-2 justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-cloud-upload-alt"></i> 上传 JAR 并构建</h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-light btn-sm" id="openConfigBtn">
                        <i class="fas fa-cog"></i> Docker 配置
                    </button>
                    <button type="button" class="btn btn-outline-light btn-sm" id="manageTemplateBtn">
                        <i class="fas fa-sliders-h"></i> 管理模板
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data" accept-charset="UTF-8">
                    <div class="mb-3">
                        <label class="form-label">选择 JAR 文件 <span class="text-danger">*</span></label>
                        <input type="file" name="jar_file" class="form-control" accept=".jar" required>
                    </div>

                    <div class="row g-3 mb-3 align-items-end">
                        <div class="col-12">
                            <label class="form-label">使用模板</label>
                            <select name="template" class="form-select">
                            </select>
                            <div class="form-text">选择预设 Dockerfile 模板</div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">镜像名称</label>
                            <input type="text" name="imagename" id="imagename" class="form-control" placeholder="myapp/demo" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">标签</label>
                            <input type="text" name="tag" id="tag" class="form-control" value="latest">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <div class="form-check">
                                <input type="checkbox" name="push" class="form-check-input" id="pushImage">
                                <label class="form-check-label" for="pushImage">构建后推送</label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg btn-build w-100">
                        <i class="fas fa-hammer"></i> 开始构建
                        <span class="spinner-border spinner-border-sm spinner ms-2" role="status"></span>
                    </button>
                </form>
            </div>
        </div>

        <!-- 导出镜像卡片 -->
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-file-export"></i> 导出 Docker 镜像</h5>
            </div>
            <div class="card-body">
                <form id="exportForm" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">镜像名称</label>
                        <input type="text" name="export_image" class="form-control" placeholder="myapp/demo" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">标签</label>
                        <input type="text" name="export_tag" class="form-control" value="latest">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">压缩方式</label>
                        <select name="export_compress" class="form-select">
                            <option value="none">不压缩 (.tar)</option>
                            <option value="gzip">GZIP (.tar.gz)</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-warning w-100">
                            <i class="fas fa-download"></i> 导出镜像
                            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" id="exportSpinner"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Docker Compose 镜像导出 -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-diagram-project"></i> Docker Compose 镜像导出</h5>
            </div>
            <div class="card-body">
                <form id="composeForm">
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="compose-file-tab" data-bs-toggle="tab" data-bs-target="#compose-file" type="button" role="tab">
                                <i class="fas fa-file-upload"></i> 上传文件
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="compose-text-tab" data-bs-toggle="tab" data-bs-target="#compose-text" type="button" role="tab">
                                <i class="fas fa-edit"></i> 文本输入
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="compose-file" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">上传 docker-compose.yml</label>
                                <input type="file" class="form-control" id="composeFileInput" accept=".yml,.yaml,.YML,.YAML,.txt">
                                <div class="form-text">自动提取 compose 文件内的镜像</div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="compose-text" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">直接输入 docker-compose.yml 内容</label>
                                <div id="composeTextEditor"></div>
                                <div class="form-text">粘贴或输入完整的 docker-compose.yml 内容（支持语法高亮）</div>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-info" id="parseComposeBtn">
                            <i class="fas fa-search"></i> 解析镜像
                        </button>
                    </div>
                </form>
                <div class="table-responsive mt-3 d-none" id="composeResult">
                    <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
                        <h6 class="mb-0">共找到 <span id="composeImageCount">0</span> 个镜像</h6>
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <div class="form-check me-2">
                                <input type="checkbox" class="form-check-input" id="selectAllImages">
                                <label class="form-check-label" for="selectAllImages">全选</label>
                            </div>
                            <select class="form-select form-select-sm" id="composeCompress" style="width: auto;">
                                <option value="none">不压缩 (.tar)</option>
                                <option value="gzip">GZIP (.tar.gz)</option>
                            </select>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="downloadSelectedBtn">
                                <i class="fas fa-download"></i> 下载选中
                            </button>
                        </div>
                    </div>
                    <table class="table table-striped align-middle" id="composeImagesTable">
                        <thead>
                            <tr>
                                <th style="width:40px;"></th>
                                <th>服务</th>
                                <th>镜像</th>
                                <th>标签/摘要</th>
                                <th class="text-end">操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 构建日志卡片 -->
        <div class="card">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-terminal"></i> 构建日志</h5>
                <button class="btn btn-sm btn-outline-light" id="clearLog"><i class="fas fa-trash"></i></button>
            </div>
            <div class="card-body p-0">
                <div class="log-container" id="buildLog"></div>
            </div>
        </div>
    </div>

    <!-- Docker 配置 Modal -->
    <div class="modal fade" id="configModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-cog"></i> Docker 配置</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="configForm" accept-charset="UTF-8">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Registry 地址</label>
                                <input type="text" name="registry" class="form-control" placeholder="docker.io">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">镜像前缀（可选）</label>
                                <input type="text" name="registry_prefix" class="form-control" placeholder="your-namespace">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">账号</label>
                                <input type="text" name="username" class="form-control" value="">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">密码</label>
                                <input type="password" name="password" class="form-control" value="">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">暴露端口</label>
                                <input type="number" name="expose_port" class="form-control" value="8080">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <div class="form-check">
                                    <input type="checkbox" name="default_push" class="form-check-input" id="defaultPush">
                                    <label class="form-check-label" for="defaultPush">默认推送镜像</label>
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-save"></i> 保存配置
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 模板管理 Modal -->
    <div class="modal fade" id="templateManagementModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-dark">
                    <h5 class="modal-title"><i class="fas fa-layer-group"></i> 模板管理</h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm" id="addTemplateBtn">
                            <i class="fas fa-plus-circle"></i> 新增模板
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>模板名称</th>
                                    <th>文件名</th>
                                    <th>大小</th>
                                    <th>更新时间</th>
                                    <th class="text-end">操作</th>
                                </tr>
                            </thead>
                            <tbody id="templateTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 template-preview d-none" id="templatePreviewPanel">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 text-muted">模板预览：<span id="templatePreviewName"></span></h6>
                            <button class="btn btn-sm btn-outline-secondary" id="closeTemplatePreview">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <pre class="template-content" id="templatePreviewContent"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模板编辑 Modal -->
    <div class="modal fade" id="templateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑模板</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="templateForm">
                        <div class="mb-3">
                            <label class="form-label">模板名称</label>
                            <input type="text" class="form-control" id="templateNameInput" required>
                            <div class="form-text">仅限字母、数字、下划线和中划线，自动附加 `.Dockerfile` 后缀</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">上传 Dockerfile（可选）</label>
                            <input type="file" class="form-control" id="templateFileInput" accept=".dockerfile,.txt,.tpl,.template,.Dockerfile">
                            <div class="form-text">选择文件后将自动读取内容填入下方编辑器</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">模板内容</label>
                            <textarea class="form-control" id="templateContentInput" rows="12" required spellcheck="false"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveTemplateBtn">
                        <i class="fas fa-save"></i> 保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer" style="z-index: 2000;"></div>

    <script src="static/js/jquery-3.7.1.min.js"></script>
    <script src="static/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="static/codemirror/js/codemirror.min.js"></script>
    <script src="static/codemirror/mode/yaml/yaml.min.js"></script>
    <script>
        $(function() {
            const $log = $('#buildLog');
            const $form = $('#uploadForm');
            const $configForm = $('#configForm');
            const $templateSelect = $('select[name="template"]');
            const $spinner = $('.spinner');
            const $pushImage = $('#pushImage');
            const $defaultPush = $('#defaultPush');
            const $exportForm = $('#exportForm');
            const $exportSpinner = $('#exportSpinner');
            const $templateTableBody = $('#templateTableBody');
            const templateModalEl = document.getElementById('templateModal');
            const templateModal = new bootstrap.Modal(templateModalEl);
            const templateManagementModalEl = document.getElementById('templateManagementModal');
            const templateManagementModal = new bootstrap.Modal(templateManagementModalEl);
            const configModalEl = document.getElementById('configModal');
            const configModal = new bootstrap.Modal(configModalEl);
            const $openConfigBtn = $('#openConfigBtn');
            const toastContainer = document.getElementById('toastContainer');
            const $composeForm = $('#composeForm');
            const $composeFileInput = $('#composeFileInput');
            const $composeResult = $('#composeResult');
            // 初始化 CodeMirror 编辑器
            const composeTextEditor = CodeMirror(document.getElementById('composeTextEditor'), {
                mode: 'yaml',
                theme: 'monokai',
                lineNumbers: true,
                lineWrapping: true,
                indentUnit: 2,
                tabSize: 2,
                indentWithTabs: false,
                autoRefresh: true
            });
            const $composeImagesTableBody = $('#composeImagesTable tbody');
            const $composeImageCount = $('#composeImageCount');
            const $selectAllImages = $('#selectAllImages');
            const $downloadSelectedBtn = $('#downloadSelectedBtn');
            const $composeCompress = $('#composeCompress');
            const $templateModalTitle = $('#templateModal .modal-title');
            function showToast(message, type = 'success') {
                if (!toastContainer) return;
                const level = type === 'error' ? 'danger' : type;
                const toastEl = document.createElement('div');
                toastEl.className = `toast align-items-center text-bg-${level} border-0 mb-2`;
                toastEl.setAttribute('role', 'alert');
                toastEl.setAttribute('aria-live', 'assertive');
                toastEl.setAttribute('aria-atomic', 'true');
                toastEl.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>`;
                toastContainer.appendChild(toastEl);
                const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                toast.show();
                toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
            }
            function downloadImage(image, tag = 'latest', compress = 'none') {
                const params = new URLSearchParams({ image, tag, compress });
                return fetch(`/export-image?${params.toString()}`)
                    .then(async res => {
                        if (!res.ok) {
                            let message = '导出失败';
                            try {
                                const data = await res.json();
                                message = data.error || message;
                            } catch (err) {
                                // ignore
                            }
                            throw new Error(message);
                        }
                        const disposition = res.headers.get('Content-Disposition') || '';
                        let filename = '';
                        const match = disposition.match(/filename="?([^";]+)"?/i);
                        if (match && match[1]) {
                            filename = match[1];
                        }
                        const blob = await res.blob();
                        const fallbackName = `${image.replace(/\//g, '_')}-${tag}.tar${compress === 'gzip' ? '.gz' : ''}`;
                        triggerDownload(blob, filename || fallbackName);
                    });
            }
            function triggerDownload(blob, filename) {
                const url = URL.createObjectURL(blob);
                const anchor = document.createElement('a');
                anchor.href = url;
                anchor.download = filename;
                document.body.appendChild(anchor);
                anchor.click();
                document.body.removeChild(anchor);
                URL.revokeObjectURL(url);
            }
            const $templateForm = $('#templateForm');
            const $templateNameInput = $('#templateNameInput');
            const $templateContentInput = $('#templateContentInput');
            const $templateFileInput = $('#templateFileInput');
            const $templatePreviewPanel = $('#templatePreviewPanel');
            const $templatePreviewName = $('#templatePreviewName');
            const $templatePreviewContent = $('#templatePreviewContent');
            let editingTemplate = null;
            let templateItems = [];
            let composeImages = [];

            // 加载配置
            function loadConfig() {
                return $.getJSON('/get-config')
                    .done(data => {
                        const docker = data.docker || {};
                        $('input[name="registry"]').val(docker.registry || 'docker.io');
                        $('input[name="registry_prefix"]').val(docker.registry_prefix || '');
                        $('input[name="expose_port"]').val(docker.expose_port || 8080);
                        $('input[name="username"]').val(docker.username || '');
                        $('input[name="password"]').val(docker.password || '');
                        $defaultPush.prop('checked', !!docker.default_push);
                        $pushImage.prop('checked', !!docker.default_push);
                    })
                    .fail(() => {
                        appendLog('❌ 加载配置失败，请检查服务是否正常', 'error');
                    });
            }

            // 加载模板列表
            function loadTemplates() {
                return fetch('/templates')
                    .then(res => {
                        if (!res.ok) {
                            throw new Error('加载模板失败');
                        }
                        return res.json();
                    })
                    .then(data => {
                        templateItems = data.items || [];
                        renderTemplateSelect();
                        renderTemplateTable();
                    })
                    .catch(() => {
                        appendLog('⚠️ 加载模板列表失败', 'error');
                    });
            }

            function renderTemplateSelect() {
                const previous = $templateSelect.val();
                $templateSelect.empty();
                if (!templateItems.length) {
                    $templateSelect.append('<option value="">暂无模板</option>');
                    return;
                }
                templateItems.forEach(item => {
                    const selected = previous === item.name ? 'selected' : '';
                    $templateSelect.append(`<option value="${item.name}" ${selected}>${item.name}</option>`);
                });
            }

            function renderTemplateTable() {
                $templateTableBody.empty();
                if (!templateItems.length) {
                    $templateTableBody.append('<tr><td colspan="5" class="text-center text-muted">暂无模板，请点击右上角按钮新增</td></tr>');
                    return;
                }
                templateItems.forEach(item => {
                    const row = `
                        <tr>
                            <td>${item.name}</td>
                            <td>${item.filename}</td>
                            <td>${formatBytes(item.size)}</td>
                            <td>${formatTime(item.updated_at)}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-secondary me-2 btn-template-preview" data-name="${item.name}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary me-2 btn-template-edit" data-name="${item.name}">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-template-delete" data-name="${item.name}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>`;
                    $templateTableBody.append(row);
                });
            }

            function formatBytes(bytes) {
                if (bytes === undefined || bytes === null) return '-';
                if (bytes === 0) return '0 B';
                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                let idx = 0;
                let value = bytes;
                while (value >= 1024 && idx < units.length - 1) {
                    value /= 1024;
                    idx++;
                }
                return `${value.toFixed(value < 10 && idx > 0 ? 1 : 0)} ${units[idx]}`;
            }

            function formatTime(timeStr) {
                if (!timeStr) return '-';
                try {
                    return new Date(timeStr).toLocaleString();
                } catch {
                    return timeStr;
                }
            }

            function fetchTemplateContent(name) {
                return fetch(`/templates?name=${encodeURIComponent(name)}`)
                    .then(res => {
                        if (!res.ok) {
                            throw new Error('加载模板失败');
                        }
                        return res.json();
                    });
            }

            function previewTemplate(name) {
                if (!name) {
                    $templatePreviewPanel.addClass('d-none');
                    return;
                }
                fetchTemplateContent(name)
                    .then(data => {
                        $templatePreviewName.text(data.name || name);
                        $templatePreviewContent.text(data.content || '');
                        $templatePreviewPanel.removeClass('d-none');
                    })
                    .catch(() => {
                        $templatePreviewName.text(name);
                        $templatePreviewContent.text('❌ 无法加载模板内容');
                        $templatePreviewPanel.removeClass('d-none');
                    });
            }

            function templateRequest(method, payload) {
                return fetch('/templates', {
                    method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload || {})
                }).then(async res => {
                    const data = await res.json().catch(() => ({}));
                    if (!res.ok) {
                        throw new Error(data.error || '操作失败');
                    }
                    return data;
                });
            }

            function openTemplateModal(name = null) {
                if (!name) {
                    editingTemplate = null;
                    $templateModalTitle.text('新增模板');
                    $templateForm[0].reset();
                    $templateFileInput.val('');
                    templateModal.show();
                    return;
                }
                fetchTemplateContent(name)
                    .then(data => {
                        editingTemplate = data.name;
                        $templateModalTitle.text('编辑模板');
                        $templateForm[0].reset();
                        $templateFileInput.val('');
                        $templateNameInput.val(data.name);
                        $templateContentInput.val(data.content || '');
                        templateModal.show();
                    })
                    .catch(() => {
                        appendLog('❌ 加载模板内容失败', 'error');
                    });
            }

            $('#addTemplateBtn').on('click', () => openTemplateModal());
            $('#manageTemplateBtn').on('click', () => {
                loadTemplates().finally(() => templateManagementModal.show());
            });
            $('#closeTemplatePreview').on('click', () => $templatePreviewPanel.addClass('d-none'));
            $openConfigBtn.on('click', () => {
                loadConfig().always(() => configModal.show());
            });

            $templateFileInput.on('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = ev => {
                    $templateContentInput.val(ev.target.result || '');
                    if (!$templateNameInput.val()) {
                        const base = (file.name || '')
                            .replace(/\.Dockerfile$/i, '')
                            .replace(/\.[^/.]+$/, '')
                            .replace(/[^a-zA-Z0-9_-]/g, '-');
                        if (base) {
                            $templateNameInput.val(base);
                        }
                    }
                };
                reader.readAsText(file);
            });

            $('#saveTemplateBtn').on('click', function() {
                const name = $templateNameInput.val().trim();
                const content = $templateContentInput.val();
                if (!name) {
                    appendLog('❌ 模板名称不能为空', 'error');
                    return;
                }
                if (!content.trim()) {
                    appendLog('❌ 模板内容不能为空', 'error');
                    return;
                }
                const payload = {
                    name,
                    content
                };
                if (editingTemplate) {
                    payload.original_name = editingTemplate;
                }
                const method = editingTemplate ? 'PUT' : 'POST';
                templateRequest(method, payload)
                    .then(data => {
                        const savedName = data.template?.name || name;
                        const msg = data.message || '模板保存成功';
                        appendLog(`✅ ${msg}`, 'success');
                        showToast(msg, 'success');
                        templateModal.hide();
                        editingTemplate = null;
                        loadTemplates().then(() => {
                            $templateSelect.val(savedName);
                        });
                    })
                    .catch(err => {
                        appendLog(`❌ ${err.message}`, 'error');
                        showToast(err.message || '模板保存失败', 'error');
                    });
            });

            $templateTableBody.on('click', '.btn-template-preview', function() {
                const name = $(this).data('name');
                if (!name) return;
                previewTemplate(name);
            });

            $templateTableBody.on('click', '.btn-template-edit', function() {
                const name = $(this).data('name');
                if (!name) return;
                openTemplateModal(name);
            });

            $templateTableBody.on('click', '.btn-template-delete', function() {
                const name = $(this).data('name');
                if (!name) return;
                if (!window.confirm(`确认删除模板 ${name} 吗？该操作不可恢复。`)) return;
                templateRequest('DELETE', { name })
                    .then(data => {
                        const msg = data.message || '模板已删除';
                        appendLog(`✅ ${msg}`, 'success');
                        showToast(msg, 'success');
                        loadTemplates().then(() => {
                            const current = $templateSelect.val();
                            if (current === name && templateItems.length) {
                                $templateSelect.val(templateItems[0].name);
                            } else if (!templateItems.length) {
                                previewTemplate(null);
                            }
                        });
                    })
                    .catch(err => {
                        appendLog(`❌ ${err.message}`, 'error');
                        showToast(err.message || '模板删除失败', 'error');
                    });
            });

            // Compose 文件输入切换时，如果已上传文件，自动填充到编辑器
            $('#compose-text-tab').on('shown.bs.tab', function() {
                const file = $composeFileInput[0]?.files?.[0];
                if (file && !composeTextEditor.getValue().trim()) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        composeTextEditor.setValue(ev.target.result);
                        composeTextEditor.refresh();
                    };
                    reader.readAsText(file);
                }
                // 刷新编辑器以确保正确显示
                setTimeout(() => composeTextEditor.refresh(), 100);
            });

            // Compose 镜像解析
            $composeForm.on('submit', function(e) {
                e.preventDefault();
                const file = $composeFileInput[0]?.files?.[0];
                const textContent = composeTextEditor.getValue()?.trim();
                
                if (file) {
                    // 优先使用上传的文件
                    const reader = new FileReader();
                    reader.onload = ev => {
                        const content = ev.target.result;
                        parseComposeContent(content);
                    };
                    reader.onerror = () => {
                        showToast('读取 compose 文件失败', 'error');
                    };
                    reader.readAsText(file);
                } else if (textContent) {
                    // 使用编辑器输入
                    parseComposeContent(textContent);
                } else {
                    showToast('请上传文件或输入 docker-compose.yml 内容', 'error');
                }
            });

            function parseComposeContent(content) {
                fetch('/parse-compose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                })
                    .then(res => res.json().then(data => ({ ok: res.ok, data })))
                    .then(({ ok, data }) => {
                        if (!ok) {
                            throw new Error(data.error || '解析失败');
                        }
                        composeImages = data.images || [];
                        renderComposeImages();
                        showToast(`解析成功，共 ${composeImages.length} 个镜像`, 'success');
                    })
                    .catch(err => {
                        composeImages = [];
                        renderComposeImages();
                        showToast(err.message || '解析失败', 'error');
                    });
            }

            function renderComposeImages() {
                $composeImagesTableBody.empty();
                if (!composeImages.length) {
                    $composeResult.addClass('d-none');
                    $composeImageCount.text('0');
                    $selectAllImages.prop('checked', false);
                    return;
                }
                $composeResult.removeClass('d-none');
                $composeImageCount.text(composeImages.length);
                composeImages.forEach((item, index) => {
                    const $row = $('<tr>');
                    const $checkboxCell = $('<td>');
                    const $checkbox = $('<input>', {
                        type: 'checkbox',
                        class: 'form-check-input compose-image-checkbox',
                        'data-index': index
                    });
                    $checkboxCell.append($checkbox);
                    $row.append($checkboxCell);
                    $row.append($('<td>').text(item.service || '-'));
                    $row.append($('<td>').text(item.image || '-'));
                    $row.append($('<td>').text(item.tag || 'latest'));
                    const $actionCell = $('<td class="text-end">');
                    const $btn = $('<button type="button" class="btn btn-sm btn-outline-primary compose-download-btn">')
                        .attr('data-index', index)
                        .append('<i class="fas fa-download"></i> 下载');
                    $actionCell.append($btn);
                    $row.append($actionCell);
                    $composeImagesTableBody.append($row);
                });
            }

            $selectAllImages.on('change', function() {
                const checked = $(this).is(':checked');
                $composeImagesTableBody.find('.compose-image-checkbox').prop('checked', checked);
            });

            $composeImagesTableBody.on('change', '.compose-image-checkbox', function() {
                const total = $composeImagesTableBody.find('.compose-image-checkbox').length;
                const checked = $composeImagesTableBody.find('.compose-image-checkbox:checked').length;
                $selectAllImages.prop('checked', total > 0 && total === checked);
            });

            $composeImagesTableBody.on('click', '.compose-download-btn', function() {
                const index = Number($(this).data('index'));
                const item = composeImages[index];
                if (!item) return;
                const compress = $composeCompress.val();
                downloadImage(item.image, item.tag || 'latest', compress)
                    .then(() => {
                        const msg = `镜像 ${item.image}:${item.tag || 'latest'} 导出成功`;
                        appendLog(`✅ ${msg}`, 'success');
                        showToast(msg, 'success');
                    })
                    .catch(err => {
                        const msg = `导出失败 ${item.image}:${item.tag || 'latest'}: ${err.message}`;
                        appendLog(`❌ ${msg}`, 'error');
                        showToast(msg, 'error');
                    });
            });

            $downloadSelectedBtn.on('click', async function() {
                const indexes = [];
                $composeImagesTableBody.find('.compose-image-checkbox:checked').each(function() {
                    indexes.push(Number($(this).data('index')));
                });
                if (!indexes.length) {
                    showToast('请先选择要下载的镜像', 'error');
                    return;
                }
                const compress = $composeCompress.val();
                const originalHtml = $(this).html();
                $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>下载中...');
                try {
                    for (const idx of indexes) {
                        const item = composeImages[idx];
                        if (!item) continue;
                        try {
                            await downloadImage(item.image, item.tag || 'latest', compress);
                            const msg = `镜像 ${item.image}:${item.tag || 'latest'} 导出成功`;
                            appendLog(`✅ ${msg}`, 'success');
                            showToast(msg, 'success');
                        } catch (err) {
                            const msg = `导出失败 ${item.image}:${item.tag || 'latest'}: ${err.message}`;
                            appendLog(`❌ ${msg}`, 'error');
                            showToast(msg, 'error');
                        }
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                } finally {
                    $(this).prop('disabled', false).html(originalHtml);
                }
            });

            // 文件选择后建议镜像名
            $('input[name="jar_file"]').on('change', function() {
                if (!this.files.length) return;
                const formData = new FormData();
                formData.append('jar_file', this.files[0]);

                $.ajax({
                    url: '/suggest-image-name',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(res) {
                        if (res.suggested_imagename) {
                            $('input[name="imagename"]').val(res.suggested_imagename);
                        }
                    },
                    error: function() {
                        appendLog('⚠️ 自动生成镜像名失败', 'error');
                    }
                });
            });

            // 保存配置
            $configForm.on('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                $.ajax({
                    url: '/save-config',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(res) {
                        if (res.message) {
                            appendLog(`✅ ${res.message}`, 'success');
                            $pushImage.prop('checked', res.docker_config?.default_push || false);
                            showToast(res.message, 'success');
                        }
                    },
                    error: function(xhr) {
                        try {
                            const res = JSON.parse(xhr.responseText);
                            appendLog(`❌ ${res.error}`, 'error');
                            showToast(res.error || '保存配置失败', 'error');
                        } catch {
                            appendLog('❌ 保存配置失败', 'error');
                            showToast('保存配置失败', 'error');
                        }
                    }
                });
            });


            // 构建处理
            $form.on('submit', function(e) {
                e.preventDefault();

                $log.empty();
                $spinner.show();
                $('button[type="submit"]').prop('disabled', true);

                const formData = new FormData(this);


                $.ajax({
                    url: '/upload',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(res) {
                        appendLog(res.message);
                        // 循环调用日志
                        pollLogs(res.build_id)
                    },
                    complete: function() {
                        $spinner.hide();
                        $('button[type="submit"]').prop('disabled', false);
                        $log.scrollTop($log[0].scrollHeight);
                    },
                    error: function(xhr) {
                        $spinner.hide();
                        $('button[type="submit"]').prop('disabled', false);
                        try {
                            const res = JSON.parse(xhr.responseText);
                            appendLog(`❌ ${res.error}`, 'error');
                        } catch {
                            appendLog('❌ 上传或构建失败', 'error');
                        }
                    }
                });
            });

            // 导出镜像
            $exportForm.on('submit', function(e) {
                e.preventDefault();
                const image = $('input[name="export_image"]').val().trim();
                const tag = $('input[name="export_tag"]').val().trim() || 'latest';
                const compress = $('select[name="export_compress"]').val();

                if (!image) {
                    appendLog('❌ 导出镜像名称不能为空', 'error');
                    return;
                }

                $exportSpinner.removeClass('d-none');
                $exportForm.find('button[type="submit"]').prop('disabled', true);

            downloadImage(image, tag, compress)
                .then(() => {
                    const msg = `镜像 ${image}:${tag} 导出成功`;
                    appendLog(`✅ ${msg}`, 'success');
                    showToast(msg, 'success');
                })
                    .catch(err => {
                    appendLog(`❌ 导出失败: ${err.message}`, 'error');
                    showToast(err.message || '导出失败', 'error');
                    })
                    .finally(() => {
                        $exportSpinner.addClass('d-none');
                        $exportForm.find('button[type="submit"]').prop('disabled', false);
                    });
            });

            async function pollLogs(buildId) {
                const logArea = document.getElementById('log');
                let lastLength = 0;

                while (true) {
                    try {
                        const res = await fetch(`/get-logs?build_id=${encodeURIComponent(buildId)}`);
                        if (!res.ok) break;
                        const logs = await res.text();
                        if (logs.length > lastLength) {
                              appendLog(logs);
                              lastLength = logs.length;
                        }

                        // 检查构建是否结束（可选：通过额外接口判断状态）
                        await new Promise(resolve => setTimeout(resolve, 500)); // 500ms 轮询
                    } catch (e) {
                        console.error("日志轮询失败:", e);
                        break;
                    }
                }
            }



            // 清空日志
            $('#clearLog').on('click', function() {
                $log.empty();
            });

            // 日志追加工具函数
            function appendLog(text, type = '') {
                const $line = $('<div>').text(text);
                if (type) $line.addClass(type);
                if (text.includes('❌')) $line.addClass('error');
                if (text.includes('✅')) $line.addClass('success');
                $log.append($line);
                $log.scrollTop($log[0].scrollHeight);
            }

            // 初始化
            loadConfig();
            loadTemplates();
        });
    </script>
</body>
</html>