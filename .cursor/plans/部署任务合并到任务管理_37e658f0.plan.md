---
name: 部署任务合并到任务管理
overview: 将部署任务功能合并到统一的任务管理系统中，使用数据库存储和后台线程执行，消除重复代码，简化架构。
todos:
  - id: extend_task_model
    content: 扩展Task模型，支持部署任务类型（task_type="deploy"），在task_config中存储部署配置
    status: completed
  - id: extend_build_task_manager
    content: 在BuildTaskManager中添加部署任务的创建和执行方法，复用现有的状态管理和日志功能
    status: completed
    dependencies:
      - extend_task_model
  - id: simplify_deploy_task_manager
    content: 简化DeployTaskManager，移除文件存储和状态管理代码，只保留核心执行逻辑
    status: completed
    dependencies:
      - extend_build_task_manager
  - id: update_routes
    content: 更新routes.py中的部署任务路由，使用BuildTaskManager替代DeployTaskManager
    status: completed
    dependencies:
      - simplify_deploy_task_manager
  - id: update_websocket_handler
    content: 更新websocket_handler.py，使用BuildTaskManager更新部署任务状态
    status: completed
    dependencies:
      - simplify_deploy_task_manager
  - id: test_integration
    content: 测试部署任务的创建、执行、状态更新和日志记录功
    status: completed
    dependencies:
      - update_routes
      - update_websocket_handler
---

# 部署任务合并到任务管理系统

## 目标

将 `DeployTaskManager` 的功能合并到 `BuildTaskManager` 中，统一使用数据库存储和后台线程执行，消除重复代码。

## 架构变更

### 当前架构

- **DeployTaskManager**: 文件系统存储（YAML + JSON），异步执行
- **BuildTaskManager**: 数据库存储（Task表），后台线程执行
- 两套独立的任务管理系统

### 目标架构

- **统一任务管理器**: 所有任务（构建、部署、导出）统一管理
- **数据库存储**: 部署任务迁移到Task表
- **后台线程执行**: 部署任务使用线程执行，与构建任务一致

## 实施步骤

### 1. 扩展Task模型

**文件**: `backend/models.py`

- 在 `Task` 模型中添加部署任务相关字段（可选，或使用 `task_config` JSON字段存储）
- 支持 `task_type="deploy"` 类型
- 添加部署任务状态字段（如果需要特殊状态）

### 2. 扩展BuildTaskManager

**文件**: `backend/handlers.py`

- 添加 `create_deploy_task()` 方法：创建部署任务并保存到数据库
- 添加 `execute_deploy_task()` 方法：在后台线程中执行部署任务
- 添加 `_execute_deploy_task_in_thread()` 方法：实际的部署执行逻辑
- 复用现有的 `update_task_status()`、`add_log()` 等方法
- 在 `list_tasks()` 中支持过滤部署任务类型

### 3. 简化DeployTaskManager

**文件**: `backend/deploy_task_manager.py`

- 保留核心执行逻辑（`_execute_target_with_executor()` 等方法）
- 移除文件系统存储相关代码（`create_task()`, `get_task()`, `list_tasks()` 等）
- 移除状态管理代码（`update_task_status()`），改为调用BuildTaskManager
- 保留配置解析和执行器创建逻辑

### 4. 更新路由

**文件**: `backend/routes.py`

- 修改 `/deploy-tasks` 相关路由，使用 `BuildTaskManager` 替代 `DeployTaskManager`
- 保持API接口不变，确保前端兼容
- 部署任务执行改为异步触发，立即返回task_id

### 5. 更新WebSocket处理

**文件**: `backend/websocket_handler.py`

- 修改WebSocket消息处理，使用BuildTaskManager更新任务状态
- 保持与Agent的通信协议不变

### 6. 数据迁移（可选）

- 创建迁移脚本，将现有文件系统存储的部署任务迁移到数据库
- 或保留文件系统作为备份，新任务使用数据库

## 关键代码变更

### BuildTaskManager扩展

```python
# 添加部署任务创建方法
def create_deploy_task(self, config_content: str, registry: str = None, tag: str = None) -> str:
    """创建部署任务并保存到数据库"""
    
# 添加部署任务执行方法
def execute_deploy_task(self, task_id: str, target_names: List[str] = None) -> str:
    """在后台线程中执行部署任务"""
    
# 添加部署执行线程方法
def _execute_deploy_task_in_thread(self, task_id: str, target_names: List[str] = None):
    """在后台线程中执行部署任务的实际逻辑"""
```

### DeployTaskManager简化

- 移除：`create_task()`, `get_task()`, `list_tasks()`, `delete_task()`, `update_task_status()`
- 保留：`_execute_target_with_executor()`, `_execute_agent_target()`, `_execute_ssh_target()`, `_execute_portainer_target()`
- 修改：执行方法接受 `task_manager` 参数，用于更新状态和日志

## 优势

1. **统一管理**: 所有任务在一个系统中管理，便于查询和监控
2. **消除重复**: 移除重复的状态管理、日志记录代码
3. **一致性**: 部署任务和构建任务使用相同的执行模式和存储方式
4. **可扩展性**: 未来添加新任务类型更容易

## 注意事项

1. 保持API兼容性，确保前端无需修改
2. 部署任务的执行是异步的，需要确保错误处理和状态更新正确
3. 考虑现有部署任务的迁移策略
4. 确保WebSocket消息处理正确更新任务状态